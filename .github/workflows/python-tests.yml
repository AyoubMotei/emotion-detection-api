name: CI - Tests Unitaires

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: "test_password"
          POSTGRES_DB: emotions_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d emotions_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install PostgreSQL client (psql)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirement.txt" ]; then
            pip install -r requirement.txt
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          # packages utiles pour tests
          pip install pytest httpx python-dotenv

      # Configure PYTHONPATH globalement pour que toutes les étapes suivantes
      # puissent importer `src.*` sans refaire export à chaque fois.
      - name: Configure PYTHONPATH
        run: |
          echo "PYTHONPATH=$(pwd):$(pwd)/src" >> $GITHUB_ENV
          echo "PYTHONPATH set to $(pwd):$(pwd)/src"

      - name: Wait for Postgres to be ready
        run: |
          until psql "postgresql://test_user:test_password@localhost:5432/emotions_db" -c '\q'; do
            echo "Postgres unavailable - sleeping 1s"
            sleep 1
          done
          echo "Postgres is up and running."

      - name: Export DB envs for src/database.py (matching your .env names)
        run: |
          # Variables avec les noms attendus par ton code: user, password, host, port, database
          echo "user=test_user" >> $GITHUB_ENV
          echo "password=test_password" >> $GITHUB_ENV
          echo "host=localhost" >> $GITHUB_ENV
          echo "port=5432" >> $GITHUB_ENV
          echo "database=emotions_db" >> $GITHUB_ENV
          # export explicite DATABASE_URL pour éviter d'éventuels parsing errors
          echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/emotions_db" >> $GITHUB_ENV

      - name: Setup ML Artifacts (Cascade + Dummy Model)
        run: |
          mkdir -p models
          echo "Téléchargement du Haar Cascade..."
          wget -q -O haarcascade_frontalface_default.xml \
            https://raw.githubusercontent.com/opencv/opencv/4.x/data/haarcascades/haarcascade_frontalface_default.xml || true
          # Crée un modèle .h5 factice si manquant (ATTENTION: fichier vide peut être incompatible si on charge le modèle)
          if [ ! -f "models/emotion_model.h5" ]; then
            echo "Création d'un modèle .h5 factice (fichier vide). Si le test charge réellement le modèle, il faudra mocker ou fournir un vrai modèle)."
            touch models/emotion_model.h5
          fi

      - name: Create Database Tables (SQLAlchemy)
        run: |
          # PYTHONPATH est déjà dans $GITHUB_ENV - accessible ici
          python -c "from src.main import Base, engin; Base.metadata.create_all(bind=engin); print('Tables créées.')"

      - name: Debug: show DB envs and DATABASE_URL
        run: |
          echo "Shell: user='$user' password='$password' host='$host' port='$port' database='$database'"
          python - <<'PY'
import os
print("Python: user=", os.getenv("user"))
print("Python: DATABASE_URL=", os.getenv("DATABASE_URL"))
PY

      - name: Run tests (with coverage)
        run: |
          python -m pytest -v --cov=src
