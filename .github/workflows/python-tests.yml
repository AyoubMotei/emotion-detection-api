name: CI - Tests Unitaires 

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]
  workflow_dispatch:   # permet de lancer manuellement depuis l'UI

jobs:
  test:
    runs-on: ubuntu-latest

    # valeurs par défaut vides pour éviter des 'None' littéraux
    env:
      user: ""
      password: ""
      host: ""
      port: ""
      database: ""

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: "test_password"
          POSTGRES_DB: emotions_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d emotions_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install PostgreSQL client (psql) - used to wait for DB
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirement.txt" ]; then
            pip install -r requirement.txt
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "Aucun requirements trouvé, installation minimale"
          fi
          pip install httpx

      - name: Wait for Postgres to be ready
        run: |
          until psql "postgresql://test_user:test_password@localhost:5432/emotions_db" -c '\q'; do
            echo "Postgres unavailable - sleeping 1s"
            sleep 1
          done
          echo "Postgres is up"

      - name: Export DB envs with the same names as your .env
        run: |
          echo "user=test_user" >> $GITHUB_ENV
          echo "password=test_password" >> $GITHUB_ENV
          echo "host=localhost" >> $GITHUB_ENV
          echo "port=5432" >> $GITHUB_ENV
          echo "database=emotions_db" >> $GITHUB_ENV
          echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/emotions_db" >> $GITHUB_ENV

      - name: Préparer fichiers locaux (models / cascades / images)
        run: |
          mkdir -p models tests/test_images
          if [ ! -f "haarcascade_frontalface_default.xml" ]; then
            wget -q -O haarcascade_frontalface_default.xml \
              https://raw.githubusercontent.com/opencv/opencv/4.x/data/haarcascades/haarcascade_frontalface_default.xml || true
          fi

      - name: Configure PYTHONPATH pour importer 'src'
        run: |
          echo "PYTHONPATH=$(pwd):$(pwd)/src" >> $GITHUB_ENV
          python -c "import sys; print('PYTHONPATH preview:', sys.path[:3])"

      - name: Debug: afficher les variables importantes (logs)
        run: |
          echo "Shell: user='$user' password='$password' host='$host' port='$port' database='$database'"
          python - <<'PY'
import os
print("Python: user =", os.getenv("user"))
print("Python: DATABASE_URL =", os.getenv("DATABASE_URL"))
PY

      - name: Run tests
        run: |
          python -m pytest -v
