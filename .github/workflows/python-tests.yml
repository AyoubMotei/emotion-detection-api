jobs:
  test:
    runs-on: ubuntu-latest

    env:
      # FORCE une DB sqlite pour la CI
      DATABASE_URL: "sqlite:///./test_db.sqlite3"
      # S'assurer que les composants individuels ne contiennent pas la chaîne "None"
      DB_USER: ""
      DB_PASSWORD: ""
      DB_HOST: ""
      DB_PORT: ""
      DB_NAME: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ... tes étapes d'installation ...

      - name: Configure le chemin d'importation pour trouver le dossier 'src'
        run: |
          echo "PYTHONPATH=$(pwd):$(pwd)/src" >> $GITHUB_ENV

      # Debug optionnel: afficher la valeur effective de DATABASE_URL (utile pour debug)
      - name: Debug: show DATABASE_URL
        run: |
          echo "DATABASE_URL='$DATABASE_URL'"
          python -c "import os; print('PYTHONURL_FROM_PY:', os.getenv('DATABASE_URL'))"

      - name: Run tests
        run: |
          # Réexporter explicitement pour être absolument certain que pytest le voit
          echo "DATABASE_URL=sqlite:///./test_db.sqlite3" >> $GITHUB_ENV
          # (optionnel) vérifier que la variable est bien définie juste avant d'exécuter pytest
          echo "After export, DATABASE_URL='$DATABASE_URL'"
          python -m pytest -v