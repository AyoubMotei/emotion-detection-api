name: CI - Tests Unitaires Simples (FastAPI + ML)

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      # Forcer sqlite en CI pour éviter Postgres
      DATABASE_URL: "sqlite:///./test_db.sqlite3"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          pip install -r requirements.txt
          
          # httpx requis par fastapi TestClient
          pip install httpx

      - name: Préparer fichiers locaux (models / cascades / images)
        run: |
          # Crée les dossiers nécessaires pour les tests
          mkdir -p models tests/test_images


          # Télécharger le haarcascade si pas déjà présent (utile pour OpenCV)
          if [ ! -f "haarcascade_frontalface_default.xml" ]; then
            wget -q -O haarcascade_frontalface_default.xml \
              https://raw.githubusercontent.com/opencv/opencv/4.x/data/haarcascades/haarcascade_frontalface_default.xml || true
          fi

      - name: Configure le chemin d'importation pour trouver le dossier 'src'
        run: |
          echo "PYTHONPATH=$(pwd):$(pwd)/src" >> $GITHUB_ENV

      - name: Run tests
        run: |
          python -m pytest -v
