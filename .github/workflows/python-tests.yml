name: CI - Tests Unitaires Simples (FastAPI + ML)

# Déclencheurs
on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

jobs:
  test:
    runs-on: ubuntu-latest

    # Env global du job : on force sqlite et on neutralise les variables individuelles
    env:
      DATABASE_URL: "sqlite:///./test_db.sqlite3"
      DB_USER: ""
      DB_PASSWORD: ""
      DB_HOST: ""
      DB_PORT: ""
      DB_NAME: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Show Python and pip versions
        run: |
          python --version
          pip --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installer requirements si présent (supporte requirement.txt et requirements.txt)
          if [ -f "requirement.txt" ]; then
            pip install -r requirement.txt
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "Aucun fichier requirements trouvé, installation minimale"
          fi
          # httpx requis par fastapi TestClient
          pip install httpx

      - name: Préparer fichiers locaux (models / cascades / images)
        run: |
          mkdir -p models tests/test_images
          echo "Si vous voulez un modèle pour les tests, ajoutez 'models/emotion_model.h5' au dépôt ou aux artefacts."
          # télécharger le haarcascade si nécessaire (utile pour OpenCV)
          if [ ! -f "haarcascade_frontalface_default.xml" ]; then
            wget -q -O haarcascade_frontalface_default.xml \
              https://raw.githubusercontent.com/opencv/opencv/4.x/data/haarcascades/haarcascade_frontalface_default.xml || true
          fi

      - name: Configure le chemin d'importation pour trouver le dossier 'src'
        run: |
          echo "PYTHONPATH=$(pwd):$(pwd)/src" >> $GITHUB_ENV
          python -c "import sys; print('PYTHONPATH preview:', sys.path[:3])"

      - name: Debug: show DATABASE_URL (value available to shell)
        run: |
          echo "DATABASE_URL (shell) = '$DATABASE_URL'"
          python - <<'PY'
import os
print("DATABASE_URL (python) =", os.getenv("DATABASE_URL"))
PY

      - name: Run tests
        run: |
          # filet de sécurité : réexport explicite pour s'assurer que pytest voit bien la variable
          echo "DATABASE_URL=sqlite:///./test_db.sqlite3" >> $GITHUB_ENV
          # vérification rapide après réexport (sera affichée dans les logs)
          echo "After export, DATABASE_URL (shell) = '$DATABASE_URL'"
          python -m pytest -v
