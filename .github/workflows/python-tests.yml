name: CI - Tests Unitaires Simples (FastAPI + ML)

# Déclencheurs : s'exécute sur push et pull_request des branches master ou main
on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

jobs:
  test:
    # OS utilisé pour le job
    runs-on: ubuntu-latest

    # Variables d'environnement accessibles dans toutes les étapes
    env:
      # On force une DB sqlite pour éviter d'avoir besoin d'un Postgres en CI.
      DATABASE_URL: "sqlite:///./test_db.sqlite3"

    steps:
      #  Récupère le code du dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      #  Prépare Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
        
          python-version: "3.13"

      #  Installe les dépendances
      - name: Install dependencies
        run: |
          # Met à jour pip
          python -m pip install --upgrade pip

          # Installer les dépendances du projet
          pip install -r requirements.txt
       
          # Installer httpx pour les tests FastAPI
          pip install httpx

      # Prépare quelques fichiers locaux nécessaires aux tests
      - name: Préparer fichiers locaux (models / cascades / images)
        run: |
          mkdir -p models tests/test_images
          # Télécharger le modèle CNN si pas déjà présent
          if [ ! -f "models/emotion_model.h5" ]; then
            wget -q -O models/emotion_model.h5 \
          # Télécharger le haarcascade si pas déjà présent 
          if [ ! -f "haarcascade_frontalface_default.xml" ]; then
            wget -q -O haarcascade_frontalface_default.xml \
              https://raw.githubusercontent.com/opencv/opencv/4.x/data/haarcascades/haarcascade_frontalface_default.xml || true
          fi

      # Définir PYTHONPATH pour trouver ton dossier src
      - name: Configure le chemin d'importation pour trouver le dossier 'src'
        run: |
          echo "PYTHONPATH=$(pwd):$(pwd)/src" >> $GITHUB_ENV

      #  Lancer les tests avec pytest
      - name: Run tests
        run: |
          python -m pytest -v
